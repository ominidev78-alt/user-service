import { Request, Response, NextFunction } from 'express';import { HttpError } from '../core/HttpError.js';import { authService } from '../app.js';import got from 'got';export async function require2FA(req: Request, res: Response, next: NextFunction) {  try {    const user = (req as any).user;    const userId = user?.id || user?.userId;    if (!userId) {      throw new HttpError(401, 'Unauthorized');    }    const code = req.body.code;    const recoveryCode = req.body.recoveryCode;    if (!code && !recoveryCode) {      try {        const data = await authService.get('api/2fa/status', {          headers: { Authorization: req.headers.authorization as string }        }).json<any>();        if (data && data.enabled) {          throw new HttpError(400, 'TwoFactorCodeRequired', {            message: 'Código 2FA é obrigatório (code ou recoveryCode)',          });        }        return next();      } catch (err: any) {        const status = err.response?.statusCode || err.status || 500;        if (status === 401) throw new HttpError(401, 'Unauthorized');        if (err instanceof HttpError) throw err;        throw new HttpError(400, 'TwoFactorCodeRequired', {          message: 'Código 2FA é obrigatório.',        });      }    }    try {      const endpoint = recoveryCode ? 'api/2fa/verify-recovery' : 'api/2fa/verify';      const payload = recoveryCode ? { code: recoveryCode } : { code };      const data = await authService.post(endpoint, {        json: payload,        headers: { Authorization: req.headers.authorization as string }      }).json<any>();      if (data && data.ok) {        delete req.body.code;        delete req.body.recoveryCode;        return next();      } else {        throw new HttpError(400, 'InvalidCode', {          message: 'Código 2FA inválido',        });      }    } catch (err: any) {      const status = err.response?.statusCode || 500;      const data: any = err.response?.body ? JSON.parse(err.response.body as string) : {};      if (status === 423) {        throw new HttpError(423, 'TwoFactorLocked', {          message: data.message || '2FA bloqueado temporariamente.',        });      }      throw new HttpError(status === 401 ? 401 : 400, data.error || 'InvalidCode', {        message: data.message || 'Erro ao verificar código 2FA.',        attemptsRemaining: data.attemptsRemaining      });    }  } catch (err) {    return next(err);  }}